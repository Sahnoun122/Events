name: CI/CD Pipeline

# DÃ©clenchement automatique
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

# Variables d'environnement globales
env:
  NODE_VERSION: '18'

jobs:
  # ===========================================
  # JOB BACKEND
  # ===========================================
  backend:
    name: Backend CI/CD
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./backend

    steps:
    # 1. Checkout du code
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    # 2. Setup Node.js
    - name: ğŸš€ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    # 3. Cache des dÃ©pendances
    - name: ğŸ“¦ Cache node modules
      uses: actions/cache@v3
      with:
        path: backend/node_modules
        key: ${{ runner.os }}-backend-node-${{ hashFiles('backend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-backend-node-

    # 4. Installation des dÃ©pendances
    - name: ğŸ“‹ Install dependencies
      run: npm ci

    # 5. Lint
    - name: ğŸ” Run ESLint
      run: npm run lint

    # 6. Tests unitaires
    - name: ğŸ§ª Run unit tests
      run: npm run test

    # 7. Tests e2e
    - name: ğŸ§ª Run e2e tests
      run: npm run test:e2e

    # 8. Build
    - name: ğŸ—ï¸ Build application
      run: npm run build

    # 9. Upload build artifacts (optionnel)
    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: backend-build
        path: backend/dist/
        retention-days: 7

  # ===========================================
  # JOB FRONTEND
  # ===========================================
  frontend:
    name: Frontend CI/CD
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./frontend

    steps:
    # 1. Checkout du code
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    # 2. Setup Node.js
    - name: ğŸš€ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    # 3. Cache des dÃ©pendances
    - name: ğŸ“¦ Cache node modules
      uses: actions/cache@v3
      with:
        path: frontend/node_modules
        key: ${{ runner.os }}-frontend-node-${{ hashFiles('frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-frontend-node-

    # 4. Installation des dÃ©pendances
    - name: ğŸ“‹ Install dependencies
      run: npm ci

    # 5. Lint
    - name: ğŸ” Run ESLint
      run: npm run lint

    # 6. Build (Next.js inclut les vÃ©rifications TypeScript)
    - name: ğŸ—ï¸ Build application
      run: npm run build

    # 7. Upload build artifacts (optionnel)
    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: frontend-build
        path: frontend/.next/
        retention-days: 7

  # ===========================================
  # JOB DOCKER BUILD (optionnel)
  # ===========================================
  docker:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.event_name == 'push'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    # Test build Docker Backend
    - name: ğŸ³ Test Docker build - Backend
      run: |
        cd backend
        docker build -t events-backend:test .

    # Test build Docker Frontend
    - name: ğŸ³ Test Docker build - Frontend
      run: |
        cd frontend
        docker build -t events-frontend:test .

    # Test Docker Compose
    - name: ğŸ³ Test Docker Compose
      run: |
        docker-compose -f docker-compose.yml config

  # ===========================================
  # JOB ANALYSE DE SÃ‰CURITÃ‰
  # ===========================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: [backend, frontend]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸš€ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    # Audit de sÃ©curitÃ© Backend
    - name: ğŸ”’ Security audit - Backend
      run: |
        cd backend
        npm audit --audit-level=high

    # Audit de sÃ©curitÃ© Frontend
    - name: ğŸ”’ Security audit - Frontend
      run: |
        cd frontend
        npm audit --audit-level=high

  # ===========================================
  # JOB NOTIFICATION (si Ã©chec)
  # ===========================================
  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [backend, frontend, docker, security]
    if: always()

    steps:
    - name: ğŸ“Š Check job status
      run: |
        if [ "${{ needs.backend.result }}" == "failure" ] || [ "${{ needs.frontend.result }}" == "failure" ]; then
          echo "âŒ Pipeline failed!"
          echo "Backend: ${{ needs.backend.result }}"
          echo "Frontend: ${{ needs.frontend.result }}"
          echo "Docker: ${{ needs.docker.result }}"
          echo "Security: ${{ needs.security.result }}"
          exit 1
        else
          echo "âœ… Pipeline succeeded!"
          echo "Backend: ${{ needs.backend.result }}"
          echo "Frontend: ${{ needs.frontend.result }}"
          echo "Docker: ${{ needs.docker.result }}"
          echo "Security: ${{ needs.security.result }}"
        fi