name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

env:
  NODE_VERSION: '18'

jobs:

  backend:
    name: Backend CI/CD
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./backend

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸš€ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ“¦ Cache node modules
      uses: actions/cache@v3
      with:
        path: backend/node_modules
        key: ${{ runner.os }}-backend-node-${{ hashFiles('backend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-backend-node-

    - name: ğŸ“‹ Install dependencies
      run: npm ci

    - name: ğŸ” Run ESLint
      run: npm run lint

    - name: ğŸ§ª Run unit tests
      run: npm run test

    - name: ğŸ§ª Run e2e tests
      run: npm run test:e2e

    - name: ğŸ—ï¸ Build application
      run: npm run build

    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: backend-build
        path: backend/dist/
        retention-days: 7


  frontend:
    name: Frontend CI/CD
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./frontend

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸš€ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ“¦ Cache node modules
      uses: actions/cache@v3
      with:
        path: frontend/node_modules
        key: ${{ runner.os }}-frontend-node-${{ hashFiles('frontend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-frontend-node-

    - name: ğŸ“‹ Install dependencies
      run: npm ci

    - name: ğŸ” Run ESLint
      run: npm run lint

    - name: ğŸ—ï¸ Build application
      run: npm run build

    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: frontend-build
        path: frontend/.next/
        retention-days: 7


  docker:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.event_name == 'push'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Test Docker build - Backend
      run: |
        cd backend
        docker build -t events-backend:test .

    - name: ğŸ³ Test Docker build - Frontend
      run: |
        cd frontend
        docker build -t events-frontend:test .

    - name: ğŸ³ Test Docker Compose
      run: |
        docker-compose -f docker-compose.yml config


  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: [backend, frontend]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸš€ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ”’ Security audit - Backend
      run: |
        cd backend
        npm audit --audit-level=high

    - name: ğŸ”’ Security audit - Frontend
      run: |
        cd frontend
        npm audit --audit-level=high


  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [backend, frontend, docker, security]
    if: always()

    steps:
    - name: ğŸ“Š Check job status
      run: |
        if [ "${{ needs.backend.result }}" == "failure" ] || [ "${{ needs.frontend.result }}" == "failure" ]; then
          echo "âŒ Pipeline failed!"
          echo "Backend: ${{ needs.backend.result }}"
          echo "Frontend: ${{ needs.frontend.result }}"
          echo "Docker: ${{ needs.docker.result }}"
          echo "Security: ${{ needs.security.result }}"
          exit 1
        else
          echo "âœ… Pipeline succeeded!"
          echo "Backend: ${{ needs.backend.result }}"
          echo "Frontend: ${{ needs.frontend.result }}"
          echo "Docker: ${{ needs.docker.result }}"
          echo "Security: ${{ needs.security.result }}"
        fi